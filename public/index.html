<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Wholesale Import</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; max-width: 1100px; }
      .row { display: flex; gap: 12px; margin-bottom: 10px; align-items: center; flex-wrap: wrap; }
      .box { border: 1px solid #ddd; padding: 12px; border-radius: 10px; }
      button { padding: 8px 12px; cursor: pointer; border-radius: 10px; border: 1px solid #ccc; background: #fff; }
      button.primary { border-color:#111; }
      input[type="number"] { padding: 6px; width: 120px; }
      .loc { display:flex; gap:10px; align-items:center; padding:6px 0; border-bottom: 1px solid #f2f2f2;}
      .loc:last-child{border-bottom:none;}
      pre { background:#111; color:#0f0; padding:12px; border-radius:10px; overflow:auto; max-height: 360px; }
      .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#f2f2f2; border:1px solid #e6e6e6; font-size:12px; }
      table { border-collapse: collapse; width: 100%; }
      th, td { border: 1px solid #e6e6e6; padding: 6px 8px; font-size: 13px; }
      th { background: #fafafa; text-align: left; }
      .muted { color: #666; font-size: 12px; }
    </style>
  </head>
  <body>
    <h1>Wholesale Import</h1>
    <div class="row">
      <span class="pill">Auto-tag: Wholesale</span>
      <span class="pill">Accepts CSV & XLSX</span>
      <span class="pill">Completes as Unpaid</span>
      <span class="pill">Moves fulfillment orders to match allocations</span>
    </div>

    <div class="box">
      <div class="row">
        <label><b>Reserve hours</b></label>
        <input id="reserveHours" type="number" value="48" min="0" />
        <small class="muted">(0 disables draft reservation)</small>
      </div>

      <div class="row">
        <label><b>Upload file</b></label>
        <input id="file" type="file" accept=".csv,.xlsx" />
        <small class="muted">Headers: product_handle, product_title (optional), unit_price, XXS..XXL</small>
      </div>
    </div>

    <h2>Pick locations and set drain order</h2>
    <div class="box" id="locationsBox">Loading locations…</div>

    <div class="row">
      <button id="previewBtn">Preview Only</button>
      <button id="downloadReportBtn">Download XLSX Report</button>
      <button id="runBtn" class="primary">Create Order</button>
    </div>

    <h2>Quick summary</h2>
    <div class="box" id="summaryBox" style="display:none;"></div>

    <h2>Raw output</h2>
    <pre id="out"></pre>

    <script>
      let locations = []; // {id,name,selected}
      const out = document.getElementById("out");
      const box = document.getElementById("locationsBox");
      const summaryBox = document.getElementById("summaryBox");

      function renderLocations() {
        const selected = locations.filter(l => l.selected);
        const unselected = locations.filter(l => !l.selected);

        box.innerHTML = `
          <div><b>Selected (drain order top → bottom)</b></div>
          ${selected.map((l) => `
            <div class="loc">
              <input type="checkbox" ${l.selected ? "checked" : ""} data-id="${l.id}" class="toggle" />
              <div style="width:320px">${l.name}</div>
              <button data-id="${l.id}" data-dir="up" class="move">↑</button>
              <button data-id="${l.id}" data-dir="down" class="move">↓</button>
            </div>
          `).join("")}
          <div style="margin-top:12px"><b>Unselected</b></div>
          ${unselected.map(l => `
            <div class="loc">
              <input type="checkbox" data-id="${l.id}" class="toggle" />
              <div style="width:320px">${l.name}</div>
            </div>
          `).join("")}
        `;

        box.querySelectorAll(".toggle").forEach(cb => {
          cb.addEventListener("change", e => {
            const id = e.target.getAttribute("data-id");
            const loc = locations.find(x => x.id === id);
            loc.selected = e.target.checked;
            renderLocations();
          });
        });

        box.querySelectorAll(".move").forEach(btn => {
          btn.addEventListener("click", e => {
            const id = e.target.getAttribute("data-id");
            const dir = e.target.getAttribute("data-dir");
            const selectedIds = locations.filter(l => l.selected).map(l => l.id);
            const idx = selectedIds.indexOf(id);
            if (idx === -1) return;

            const swapWith = dir === "up" ? idx - 1 : idx + 1;
            if (swapWith < 0 || swapWith >= selectedIds.length) return;

            const a = selectedIds[idx], b = selectedIds[swapWith];

            const selectedLocs = locations.filter(l => l.selected);
            const unselectedLocs = locations.filter(l => !l.selected);

            const newSelectedIds = [...selectedIds];
            newSelectedIds[idx] = b;
            newSelectedIds[swapWith] = a;

            const newSelected = newSelectedIds.map(id2 => selectedLocs.find(x => x.id === id2));
            locations = [...newSelected, ...unselectedLocs];
            renderLocations();
          });
        });
      }

      async function loadLocations() {
        const res = await fetch("/api/locations");
        const json = await res.json();
        if (json.error) throw new Error(json.error);

        // Default pre-select your common locations (in your preferred drain order)
        const preferred = ["Warehouse", "Bogota", "Cedarhurst", "Teaneck Store", "Toms River"];
        const map = new Map(json.locations.map(l => [l.name, l]));

        const selected = [];
        for (const name of preferred) if (map.has(name)) selected.push({...map.get(name), selected:true});

        const rest = json.locations
          .filter(l => !preferred.includes(l.name))
          .map(l => ({...l, selected:false}));

        locations = [...selected, ...rest];
        renderLocations();
      }

      function getFormData() {
        const file = document.getElementById("file").files[0];
        const reserveHours = document.getElementById("reserveHours").value;
        const selectedIds = locations.filter(l => l.selected).map(l => l.id);

        if (!file) throw new Error("Choose a CSV or XLSX file.");
        if (selectedIds.length === 0) throw new Error("Select at least one location.");

        const form = new FormData();
        form.append("file", file);
        form.append("reserveHours", reserveHours);
        form.append("locationIdsJson", JSON.stringify(selectedIds));
        return form;
      }

      function showSummary(json) {
        if (!json || !json.report) { summaryBox.style.display="none"; return; }
        summaryBox.style.display = "block";

        const r = json.report;
        const alloc = r.allocatedUnits ?? 0;
        const req = r.requestedUnits ?? 0;
        const drop = r.droppedUnits ?? 0;

        // If import mode, show final fulfillment summary if present
        const ff = json.finalFulfillment?.summary || null;

        summaryBox.innerHTML = `
          <div class="row">
            <span class="pill">Requested: ${req}</span>
            <span class="pill">Fulfillable: ${alloc}</span>
            <span class="pill">Dropped: ${drop}</span>
            ${json.mode ? `<span class="pill">Mode: ${json.mode}</span>` : ""}
            ${json.orderName ? `<span class="pill">Order: ${json.orderName}</span>` : ""}
          </div>
          ${ff ? `
            <div style="margin-top:10px"><b>Final fulfillment by location</b></div>
            <table style="margin-top:6px">
              <tr><th>Location</th><th>Units</th></tr>
              ${Object.entries(ff).map(([k,v]) => `<tr><td>${k}</td><td>${v}</td></tr>`).join("")}
            </table>
          ` : `<div class="muted">Tip: Run “Create Order” to see final fulfillment splits.</div>`}
        `;
      }

      async function postJson(endpoint) {
        out.textContent = "Running…";
        summaryBox.style.display = "none";

        try {
          const form = getFormData();
          const res = await fetch(endpoint, { method: "POST", body: form });
          const json = await res.json();
          out.textContent = JSON.stringify(json, null, 2);
          showSummary(json);
        } catch (e) {
          out.textContent = String(e.message || e);
        }
      }

      document.getElementById("previewBtn").addEventListener("click", () => postJson("/api/preview"));
      document.getElementById("runBtn").addEventListener("click", () => postJson("/api/import"));

      document.getElementById("downloadReportBtn").addEventListener("click", async () => {
        out.textContent = "Generating report…";
        summaryBox.style.display = "none";

        try {
          const form = getFormData();
          const res = await fetch("/api/report.xlsx", { method: "POST", body: form });
          if (!res.ok) {
            const json = await res.json().catch(() => ({}));
            out.textContent = JSON.stringify(json || { error: "Failed to generate report" }, null, 2);
            return;
          }
          const blob = await res.blob();
          const url = URL.createObjectURL(blob);

          const a = document.createElement("a");
          a.href = url;
          a.download = "fulfillment_report.xlsx";
          document.body.appendChild(a);
          a.click();
          a.remove();

          out.textContent = "Downloaded fulfillment_report.xlsx";
        } catch (e) {
          out.textContent = String(e.message || e);
        }
      });

      loadLocations().catch(e => box.textContent = e.message);
    </script>
  </body>
</html>
